# 📌 클러스터링을 통한 포트폴리오 최적화

이 코드는 `yfinance`를 사용하여 S&P 500 주요 기업들의 주가 데이터를 수집하고, 전처리 후 CSV 파일로 저장하는 전체 프로세스를 포함하고 있다.

---

## 1️⃣ **라이브러리 임포트**
먼저 데이터 수집과 처리를 위해 필요한 라이브러리를 불러온다.
- `yfinance` : Yahoo Finance API를 통해 주가 데이터를 다운로드하는 라이브러리.
- `pandas` : 데이터를 처리하고 CSV로 저장하는 데 사용.
- `os` : 파일 저장 경로를 관리하기 위해 사용.

---

## 2️⃣ **S&P 500 기업 티커 리스트 정의**
S&P 500 기업 중 특정 개수(예: 100개)의 기업을 선정하여 주식 티커(symbol) 리스트를 생성한다. 
- 이 티커 리스트는 Yahoo Finance에서 데이터를 가져올 때 사용된다.
- 리스트는 하드코딩되거나, 특정 기준(예: 시가총액 상위 100개 기업)을 기반으로 자동 생성될 수도 있다.

---

## 3️⃣ **주가 데이터 다운로드**
Yahoo Finance API를 사용하여 주가 데이터를 다운로드하는 과정.
- `yfinance.download()` 함수를 사용하여 티커 리스트에 해당하는 데이터를 한 번에 가져온다.
- 기간은 **2020년 1월 1일 ~ 2020년 12월 31일**로 설정됨.
- 데이터는 `Adj Close`(조정 종가) 값만 선택하여 저장.

📌 **수집되는 데이터 항목**
- 날짜(`Date`)
- 조정 종가(`Adj Close`): 배당금, 주식 분할 등을 반영한 실제 주가.

---

## 4️⃣ **데이터 전처리**
다운로드한 데이터의 품질을 높이기 위해 전처리 과정을 거친다.

### ✅ 4-1. 인덱스 변환
- 기본적으로 `Date` 컬럼이 인덱스로 설정되므로, 이를 명확하게 변환하여 데이터프레임으로 활용.

### ✅ 4-2. 결측치 처리
- 일부 주식의 경우 특정 날짜에 데이터가 없을 수 있음.
- `dropna()` 함수를 사용하여 결측값이 포함된 행을 제거.

### ✅ 4-3. 데이터 정렬 및 확인
- 데이터를 날짜순으로 정렬하여 분석이 용이하도록 구성.
- 주가 데이터가 올바르게 다운로드되었는지 `head()` 또는 `info()`를 사용해 확인.

---

## 5️⃣ **데이터 저장 (CSV 파일)**
전처리된 데이터를 CSV 파일로 저장한다.
- `to_csv()` 함수를 사용하여 로컬 저장.
- 파일 이름은 예를 들어 `"sp500_prices_2020.csv"` 형태로 지정.
- 저장 경로를 지정하여, 기존 파일이 있을 경우 덮어쓸 수 있도록 처리.

---

## 6️⃣ **예외 처리 및 로깅**
데이터 다운로드 및 저장 과정에서 오류가 발생할 수 있으므로 예외 처리를 포함한다.
- **네트워크 오류 처리**: Yahoo Finance API는 가끔 응답이 느리거나 실패할 수 있으므로, `try-except` 블록을 활용.
- **누락된 주식 데이터 감지**: 특정 주식이 다운로드되지 않은 경우 로그를 남김.
- **파일 저장 오류 처리**: 파일이 정상적으로 저장되었는지 확인.

---

## 7️⃣ **활용 방안**
이 데이터를 활용하여 다양한 금융 데이터 분석이 가능하다.
### 📊 **가능한 분석 방법**
1. **시계열 분석**: 특정 주식의 가격 변동 분석.
2. **상관관계 분석**: 여러 주식 간의 가격 움직임 비교.
3. **포트폴리오 최적화**: 위험 대비 수익률이 높은 주식 조합 찾기.
4. **머신러닝 모델 학습**: 주가 예측 모델 개발.

---

# ✅ **정리**
이 코드의 전체 프로세스는 다음과 같다.

1️⃣ **라이브러리 임포트**  
2️⃣ **S&P 500 티커 리스트 정의**  
3️⃣ **주가 데이터 다운로드 (`yfinance.download`)**  
4️⃣ **데이터 전처리 (결측치 제거, 정렬 등)**  
5️⃣ **CSV 파일로 저장 (`to_csv`)**  
6️⃣ **예외 처리 및 로깅**  
7️⃣ **데이터 분석 및 모델링 활용**

이 과정을 통해 S&P 500 주요 기업의 주가 데이터를 효과적으로 다운로드하고 저장할 수 있다.

# 📌 S&P 500 주가 데이터 기반 포트폴리오 최적화 프로세스

이 프로젝트는 S&P 500 주요 종목들의 2021년 주가 데이터를 활용하여 연간 수익률을 계산하고, 현대 포트폴리오 이론을 적용하여 최적의 투자 포트폴리오를 구성하는 과정을 포함한다.

---

## 1️⃣ **데이터 로드 및 주가 데이터 다운로드**
- `selected_data.csv` 파일을 로드하여 분석할 종목 리스트를 가져온다.
- `yfinance` 라이브러리를 사용하여 2021년 1월 1일부터 12월 31일까지의 주가 데이터를 다운로드한다.
- `Adj Close`(조정 종가) 데이터를 사용하여 분석을 진행.

---

## 2️⃣ **연간 수익률 계산**
- 2021년 첫 거래일(1월 4일)과 마지막 거래일(12월 30일)의 주가를 비교하여 연간 수익률을 계산.
- 공식:  
  \[
  \text{Annual Return} = \frac{\text{Last Price} - \text{First Price}}{\text{First Price}} \times 100
  \]
- 모든 종목의 평균 연간 수익률도 계산.

📌 **결과**
- 평균 연간 수익률: **39.13%**
- (매출 및 EPS 성장률이 Low) 종목의 평균 수익률: **38%**
- (매출 및 EPS 성장률이 High) 종목의 평균 수익률: **39%**

---

## 3️⃣ **현대 포트폴리오 이론을 통한 포트폴리오 최적화**
### ✅ **(1) 일간 수익률 및 공분산 행렬 계산**
- `pct_change()`를 사용하여 일일 수익률을 계산하고, 연간 평균 수익률(252 거래일 기준)을 구한다.
- 공분산 행렬을 계산하여 자산 간의 변동성 관계를 파악.

### ✅ **(2) 최적 포트폴리오 구성**
- 샤프 비율(Sharpe Ratio)을 최대화하는 포트폴리오를 찾기 위해 **최적화 알고리즘** 적용.
- 최적화 함수:  
  \[
  \text{Sharpe Ratio} = \frac{E(R_p) - R_f}{\sigma_p}
  \]
  - \(E(R_p)\): 포트폴리오 기대 수익률
  - \(R_f\): 무위험 이자율 (0.01 사용)
  - \(\sigma_p\): 포트폴리오 변동성
- `scipy.optimize.minimize()`를 사용하여 최적의 투자 비율을 찾음.

### ✅ **(3) 효율적 프론티어 계산 및 시각화**
- 목표 수익률을 기준으로 변동성이 가장 낮은 포트폴리오를 찾음.
- 효율적 프론티어(Efficient Frontier)를 계산하고 시각화.

📌 **결과**
- **최적 포트폴리오의 기대 수익률**: **62.99%**
- **연간 변동성(리스크)**: **12.44%**
- **샤프 비율**: **4.98**

---

## 4️⃣ **포트폴리오 최적화 전후 비교**
### **✔ 시나리오 1 (매출 및 EPS 성장률 High)**
- 2020년 수익률: **111.88%**
- 2021년 수익률: **62.98%**

### **✔ 시나리오 2 (매출 및 EPS 성장률 Low)**
- 2020년 수익률: **70.91%**
- 2021년 수익률: **52.79%**

📌 **결론**  
- 매출 성장률과 EPS 성장률이 낮은 기업일수록 **수익률도 낮아지는 경향**이 있음.
- **포트폴리오 최적화 전후 비교**
  - 최적화 전: 두 시나리오 간 수익률 차이 **1%**
  - 최적화 후: 두 시나리오 간 수익률 차이 **10%**
  - **포트폴리오 최적화를 통해 수익률 차이가 더 커짐**, 즉, 성장성이 높은 종목을 포함한 포트폴리오가 더 높은 성과를 보임.

---

# ✅ **최종 정리**
1️⃣ **2021년 주가 데이터를 다운로드하여 연간 수익률 계산**  
2️⃣ **매출 및 EPS 성장률이 높은 기업과 낮은 기업 간 수익률 비교**  
3️⃣ **포트폴리오 최적화를 적용하여 샤프 비율 최대화**  
4️⃣ **효율적 프론티어를 계산하고 최적 포트폴리오 시각화**  
5️⃣ **최적화 전후의 수익률 차이를 분석하여 최적화의 효과 확인**

이 과정을 통해 **최적의 투자 포트폴리오를 구성**하고, **성장성이 높은 종목에 대한 투자 효과를 검증**할 수 있었다.

